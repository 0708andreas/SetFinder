<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Hello OpenCV.js</title>
    </head>
    <body>
        <h2>Hello OpenCV.js</h2>
        <p id="status">OpenCV.js is loading...</p>
        <div>
            <div class="inputoutput">
                <img id="imageSrc" width="50%" alt="No Image" />
                <div class="caption">
                    imageSrc <input type="file" id="fileInput" name="file" />
                </div>
            </div>
            <div class="inputoutput">
                <video id="video">Webcam stream not started</video>
                <div class="caption">
                    camSrc
                    <input
                        type="button"
                        id="videoInput"
                        value="Take picture"
                        onclick="takePicture()"
                    />
                </div>
                <canvas id="captureCanvas" style="display: none"></canvas>
            </div>
            <div class="inputoutput">
                <canvas id="canvasOutput" width="#50%#"></canvas>
                <div class="caption">canvasOutput</div>
            </div>
        </div>
        <script async src="opencv.js" type="text/javascript"></script>
        <script src="set.js" type="text/javascript"></script>
        <script type="text/javascript">
            let imgElement = document.getElementById("imageSrc");
            let inputElement = document.getElementById("fileInput");
            inputElement.addEventListener(
                "change",
                (e) => {
                    imgElement.src = URL.createObjectURL(e.target.files[0]);
                },
                false,
            );
            var height = undefined;
            var width = undefined;
            imgElement.onload = do_cv_magic;
            // imgElement.onload = function () {
            //     let mat = cv.imread(imgElement);
            //     cv.imshow("canvasOutput", mat);
            //     mat.delete();
            // };

            var Module = {
                // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
                onRuntimeInitialized() {
                    document.getElementById("status").innerHTML =
                        "OpenCV.js is ready.";

                    let video = document.getElementById("video");
                    navigator.mediaDevices
                        .getUserMedia({ video: true, audio: false })
                        .then((stream) => {
                            video.srcObject = stream;
                            video.play();
                            height = video.videoHeight;
                            width = video.videoWidth;
                        });
                },
            };
        </script>
    </body>
</html>
